---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import FormattedDate from '../components/FormattedDate.astro';

// 1. Fetch all blog posts
const posts = await getCollection("blog");

// 2. Sort posts by date in descending order
posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// 3. Get the 3 most recent posts
const latestPosts = posts.slice(0, 3);
const housingPosts = posts.filter(post => post.data.tags && post.data.tags.includes('housing-simulation'));

// Remove the shuffle function and randomizedArticles assignment
---

<head>
  <!-- Force browsers to re-fetch favicon when you bump the version -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2" />
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2" />
  <!-- optional: mobile theme color -->
  <meta name="theme-color" content="#ffffff" />
  <!-- Add other common icons if you have them -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=2" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=2" />
</head>

<BaseLayout>
  <div class="container">
    <div class="hero-section">
      <h1 class="hero-title">
        <span class="primary-text">Next</span><span class="accent-text">Val</span><span class="primary-text">Data</span>
      </h1>
      <p class="hero-subtitle">
        Data insights, analytics, and technical explorations.
      </p>
      <div class="hero-ctas">
        <a href="/blog" class="btn btn-primary">Read latest posts</a>
        <a href="/interesting-articles/" class="btn btn-ghost">View all articles</a>
      </div>
    </div>

    <!-- New: Featured post card (promote the most recent post) -->
    {
      latestPosts.length > 0 && (
        <section class="featured-section mb-8">
          <h2 class="sr-only">Featured</h2>
          <article class="featured-card">
            <a href={`/blog/${latestPosts[0].slug}/`} class="featured-link">
              <div class="featured-content">
                <h3 class="featured-title">{latestPosts[0].data.title}</h3>
                <p class="featured-excerpt">{latestPosts[0].data.description}</p>
                <p class="text-sm text-gray-500">{new Date(latestPosts[0].data.pubDate).toLocaleDateString()}</p>
              </div>
            </a>
          </article>
        </section>
      )
    }

    <!-- Latest Posts Section (grid of remaining latest posts) -->
    {
      latestPosts.length > 1 && (
        <div class="latest-posts mb-12">
          <h2 class="text-2xl font-bold mb-4">Latest Posts</h2>
          <div class="posts-grid">
            {latestPosts.map((post, idx) => (
              <div class={`post-card ${idx === 0 ? 'hidden-md' : ''}`}>
                <a href={`/blog/${post.slug}/`} class="post-link">
                  {post.data.heroImage && <img src={post.data.heroImage} alt="" class="post-image" />}
                  <h4 class="title">{post.data.title}</h4>
                  <p class="date"><FormattedDate date={post.data.pubDate} /></p>
                  <p class="excerpt">{post.data.description}</p>
                </a>
              </div>
            ))}
          </div>
          <div class="mt-6 text-center">
            <a href="/blog" class="inline-block px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition-colors">View All Blog Posts</a>
          </div>
        </div>
      )
    }

    <!-- Articles I am reading/have read Section -->
    <section id="all-articles" class="mb-12">
      <h2 class="text-2xl font-bold mb-4">Interesting Articles</h2>

      <!-- small client-side filter -->
      <div class="articles-controls mb-4">
        <input id="article-filter" placeholder="Filter by keyword (e.g. AI, Databases)" class="input-filter" />
      </div>

      <div id="articles-list" class="space-y-4">
        <!-- Articles will be rendered by client-side JS -->
      </div>

      <div class="mt-6 text-center">
        <a href="/interesting-articles/" class="inline-block px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition-colors">
          View All Articles
        </a>
      </div>
    </section>
  </div>
</BaseLayout>

<script is:inline>
  // client-side: simple filter for the interesting-articles widget (works with existing fetch-rendering)
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('article-filter');
    const list = document.getElementById('articles-list');

    // reuse existing fetch logic to populate articles initially
    async function loadArticles() {
      try {
        const res = await fetch('/data/articles.json');
        const articles = await res.json();
        renderArticles(articles);
      } catch (e) {
        list.innerHTML = '<p class="text-gray-500">Failed to load articles</p>';
      }
    }

    function renderArticles(items, q = '') {
      const qlc = (q || '').toLowerCase().trim();
      let out = '';
      const filtered = qlc ? items.filter(a => (a.title + ' ' + (a.author||'') + ' ' + (a.area||'')).toLowerCase().includes(qlc)) : items;
      if (!filtered.length) {
        list.innerHTML = '<p class="text-gray-500">No articles match your filter.</p>';
        return;
      }
      list.innerHTML = '';
      filtered.forEach(a => {
        const div = document.createElement('div');
        div.className = 'border-b pb-4';
        div.innerHTML = `<a href="${a.url}" target="_blank" rel="noopener" class="text-lg font-semibold text-blue-600 hover:underline">${a.title}</a>
                         <p class="text-sm text-gray-500">${a.author} â€” ${a.area}</p>`;
        list.appendChild(div);
      });
    }

    input && input.addEventListener('input', (e) => {
      const q = e.target.value;
      fetch('/data/articles.json').then(res => res.json()).then(articles => renderArticles(articles, q)).catch(()=>{});
    });

    loadArticles();
  });
</script>

<style>
  /* Page container */
  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  /* Tighter hero */
  .hero-section {
    padding: 2rem 0 2.5rem 0; /* slightly reduced */
    text-align: center;
  }
  .hero-subtitle {
    max-width: 680px;
    margin: 0.5rem auto 1rem auto;
    font-size: 1.05rem;
    color: rgba(102,102,102,0.95);
  }
  .hero-ctas { display: flex; gap: 0.75rem; justify-content: center; margin-top: .75rem; }
  .btn { padding: .6rem 1rem; border-radius: 10px; text-decoration: none; display:inline-block; }
  .btn-primary { background: var(--accent, #ff8c42); color:#fff; font-weight:600; box-shadow:0 8px 20px rgba(255,107,53,0.12); }
  .btn-ghost { background: transparent; color: #ff8c42; border: 1px solid rgba(255,107,53,0.12); }

  /* Featured card */
  .featured-section { margin-bottom: 1.5rem; }
  .featured-card {
    border-radius: 12px;
    background: linear-gradient(180deg, #fff, #fff);
    border: 1px solid rgba(255,107,53,0.06);
    box-shadow: 0 8px 28px rgba(255,107,53,0.04);
    overflow: hidden;
  }
  .featured-link { display: block; padding: 1.25rem; color: inherit; text-decoration:none; }
  .featured-title { margin: 0 0 .25rem 0; font-size: 1.25rem; line-height:1.05; }
  .featured-excerpt { margin: 0 0 .6rem 0; color: rgba(102,102,102,0.9); }

  /* Posts grid */
  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1rem;
  }
  .post-card {
    border-radius: 10px;
    overflow: hidden;
    background: white;
    border: 1px solid rgba(0,0,0,0.04);
    transition: transform .18s ease, box-shadow .18s ease;
  }
  .post-card:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(0,0,0,0.06); }
  .post-image { width:100%; height:140px; object-fit:cover; display:block; }
  .post-link { display:block; padding: 1rem; color: inherit; text-decoration:none; }
  .post-link .title { font-size: 1.05rem; margin: 0 0 .4rem 0; }
  .post-link .excerpt { color: rgba(80,80,80,0.9); font-size: .95rem; margin-top:.5rem; }

  /* Small filter input */
  .articles-controls { display:flex; justify-content:flex-end; }
  .input-filter { padding:.5rem .75rem; border:1px solid rgba(0,0,0,0.08); border-radius:8px; max-width:360px; }

  @media (max-width:720px) {
    .hero-ctas { flex-direction: column; gap:.5rem; }
  }
</style>