---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import FormattedDate from "../components/FormattedDate.astro";

// Fetch posts and sort
const posts = await getCollection("blog");
posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const latestPosts = posts.slice(0, 3);
---

<BaseLayout>
  <div class="container">
    <div class="hero-section">
      <h1 class="hero-title relative z-10" id="hero-title-shake-zone">
        <span class="primary-text">Next</span>
        <!-- Val Door Wrapper -->
        <span class="val-door-wrapper relative inline-block align-bottom">
          <a
            href="/login"
            id="login-secret"
            class="login-secret absolute inset-0 flex items-center justify-center opacity-0 pointer-events-none z-0"
          >
            <img
              src="/img/cartoon_door.png"
              alt="Login Door"
              class="h-24 w-auto hover:brightness-110 transition-all"
            />
          </a>
          <span
            id="swing-val"
            class="accent-text relative z-10 cursor-help inline-block origin-left"
            >Val</span
          >
        </span>
        <span class="primary-text">Data</span>
      </h1>
      <p class="hero-subtitle">
        Data insights, analytics, and technical explorations.
      </p>
    </div>

    <!-- Latest Posts (top 3) -->
    {
      latestPosts.length > 0 && (
        <div class="latest-posts mb-12">
          <div class="section-header mb-4">
            <h2 class="text-2xl font-bold default-title">Latest Posts</h2>
            <img
              src="/img/holiday/latest_posts.png"
              alt="Latest Posts"
              class="holiday-title"
              hidden
            />
          </div>
          <div class="flex flex-col gap-6 mt-4">
            {latestPosts.map((post) => (
              <div class="border-b pb-4 last:border-b-0">
                <a
                  href={`/blog/${post.slug}/`}
                  class="text-xl font-bold text-blue-600 dark:text-blue-400 hover:underline"
                >
                  {post.data.title}
                </a>
                <p class="mt-2 text-gray-700 dark:text-gray-300">
                  {post.data.description}
                </p>
                <p class="text-sm text-gray-500 mt-1">
                  <FormattedDate date={post.data.pubDate} />
                </p>
              </div>
            ))}
          </div>
          <div class="mt-6 text-center">
            <a
              href="/blog"
              class="inline-block px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition-colors"
            >
              View All Blog Posts
            </a>
          </div>
        </div>
      )
    }

    <!-- Interesting Articles: show 3 random from public/data/articles.json -->
    <section id="all-articles" class="mb-12">
      <h2 class="text-2xl font-bold mb-4">From my Reading List</h2>
      <div id="articles-list" class="space-y-4">
        <!-- client-side will render 3 random articles here -->
      </div>
      <div class="mt-6 text-center">
        <a
          href="/interesting-articles/"
          class="inline-block px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition-colors"
          >View All Articles</a
        >
      </div>
    </section>
  </div>
</BaseLayout>

<script is:inline>
  document.addEventListener("DOMContentLoaded", function () {
    // ---------------------------------------------------------
    // 1. Easter Egg: Shake "Val" to Open Door
    // ---------------------------------------------------------
    const shakeZone = document.getElementById("hero-title-shake-zone");
    const valDoor = document.getElementById("swing-val");
    const secretLink = document.getElementById("login-secret");

    let lastX = 0;
    let shakeCount = 0;
    let lastDir = 0; // -1 left, 1 right
    let resetTimer = null;
    let isOpen = false;

    if (shakeZone && valDoor && secretLink) {
      shakeZone.addEventListener("mousemove", (e) => {
        if (isOpen) return;

        const currentX = e.clientX;
        const delta = currentX - lastX;
        const direction = delta > 0 ? 1 : -1;

        // Detect fast movement direction change (Shake)
        if (Math.abs(delta) > 5) {
          // Minimum speed
          if (direction !== lastDir) {
            shakeCount++;
            lastDir = direction;

            // Reset count if stopped shaking
            clearTimeout(resetTimer);
            resetTimer = setTimeout(() => {
              shakeCount = 0;
            }, 300);

            // TRIGGER: 5 shakes in 300ms
            if (shakeCount > 5) {
              triggerOpen();
            }
          }
        }
        lastX = currentX;
      });

      // ---------------------------------------------------------
      // mobile swipe support
      // ---------------------------------------------------------
      let touchStartX = 0;
      let touchStartY = 0;

      shakeZone.addEventListener(
        "touchstart",
        (e) => {
          touchStartX = e.changedTouches[0].clientX;
          touchStartY = e.changedTouches[0].clientY;
        },
        { passive: true },
      );

      shakeZone.addEventListener(
        "touchmove",
        (e) => {
          if (isOpen) return;
        },
        { passive: true },
      );

      shakeZone.addEventListener("touchend", (e) => {
        if (isOpen) return;

        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;

        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;

        // Debugging for mobile
        console.log(`Swipe Delta: X=${deltaX}, Y=${deltaY}`);

        // Thresholds (relaxed for easier triggering):
        // 1. Horizontal distance > 30px
        // 2. Vertical distance < 75px (allow sloppy horizontal swipes)
        if (Math.abs(deltaX) > 30 && Math.abs(deltaY) < 75) {
          console.log("Swipe Detected! Opening door...");
          triggerOpen();
        }
      });

      function triggerOpen() {
        isOpen = true;
        valDoor.classList.add("door-open");
        secretLink.classList.remove("opacity-0", "pointer-events-none");
        secretLink.classList.add("opacity-100", "pointer-events-auto");

        // Auto close after 5 seconds if not interacted
        setTimeout(() => {
          // valDoor.classList.remove('door-open');
          // secretLink.classList.add('opacity-0', 'pointer-events-none');
          // secretLink.classList.remove('opacity-100', 'pointer-events-auto');
          // isOpen = false;
        }, 5000);
      }
    }

    // ---------------------------------------------------------
    // 2. Fetch Articles Logic
    // ---------------------------------------------------------
    fetch("/data/articles.json")
      .then((res) =>
        res.ok
          ? res.json()
          : Promise.reject(new Error("articles.json not found")),
      )
      .then((articles) => {
        function shuffle(array) {
          let arr = array.slice();
          for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
          }
          return arr;
        }
        const three = shuffle(articles).slice(0, 3);
        const container = document.getElementById("articles-list");
        if (!container) return;
        container.innerHTML = "";
        three.forEach((article) => {
          const wrapper = document.createElement("div");
          wrapper.className = "border-b pb-4 last:border-b-0";
          const a = document.createElement("a");
          a.href = article.url;
          a.target = "_blank";
          a.rel = "noopener";
          a.className =
            "text-xl font-bold text-blue-600 dark:text-blue-400 hover:underline";
          a.textContent = article.title;
          wrapper.appendChild(a);

          if (article.description) {
            const pDesc = document.createElement("p");
            pDesc.className = "mt-2 text-gray-700 dark:text-gray-300";
            pDesc.textContent = article.description;
            wrapper.appendChild(pDesc);
          }

          const meta = document.createElement("p");
          meta.className = "text-sm text-gray-500 mt-1";
          meta.textContent = `${article.author || ""}${article.author ? " — " : ""}${article.area || ""}`;
          wrapper.appendChild(meta);

          container.appendChild(wrapper);
        });
      })
      .catch((err) => {
        const container = document.getElementById("articles-list");
        if (container)
          container.innerHTML =
            '<p class="text-gray-500">Unable to load articles.</p>';
        console.warn("Failed to load articles.json", err);
      });
  });
</script>

<style>
  /* Page container */
  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  /* HERO — smaller, tighter, consistent with body text */
  .hero-section {
    text-align: center;
    padding: 2.25rem 0 2.75rem 0;
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.05), transparent);
    border-radius: 16px;
    margin-bottom: 1.75rem;
  }

  /* Tighten the title: smaller max, larger min, better line-height */
  .hero-title {
    font-size: clamp(2.25rem, 6vw, 3.25rem); /* reduced max and min */
    font-weight: 900;
    margin-bottom: 0.6rem;
    line-height: 1.02;
    color: #222;
    display: inline-block;
    /* ensure GPU compositing for smoother transforms */
    transform: translateZ(0);
    /* Important for Shake Detection zone */
    cursor: default;
    /* Tighter letter spacing as requested */
    letter-spacing: -0.05em;
    position: relative;
  }

  /* Holiday Mode Background Garland */
  /* Holiday Mode Background Garland */

  /* Slightly smaller, more compact subtitle */
  .hero-subtitle {
    max-width: 680px;
    margin: 0.25rem auto 0.75rem auto;
    font-size: clamp(0.98rem, 1.9vw, 1.05rem);
    color: rgba(102, 102, 102, 0.9);
    line-height: 1.45;
    position: relative;
    z-index: 20;
  }

  /* CTA spacing minor tweak */
  .hero-ctas {
    display: flex;
    gap: 0.6rem;
    justify-content: center;
    margin-top: 0.65rem;
  }

  /* ------------------------------- */
  /* EASTER EGG STYLES ("Val" Door) */
  /* ------------------------------- */
  .val-door-wrapper {
    perspective: 1000px; /* Essential for 3D Swing */
    display: inline-block; /* Fix layout */
  }

  /* The Hidden Link */
  .login-secret {
    transition: opacity 0.5s ease 0.3s; /* Delay visibility slightly */
  }
  /* ------------------------------- */

  .hero-title .primary-text {
    /* darker neutral gradient */
    background: linear-gradient(90deg, #2b2b2b 0%, #4a4a4a 50%, #2b2b2b 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .hero-title .accent-text {
    /* accent gradient used across the site */
    background: linear-gradient(
      90deg,
      var(--accent, #ff8c42) 0%,
      #ffb07a 60%,
      var(--accent, #ff8c42) 100%
    );
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;

    display: inline-block;
    position: relative;

    /* Animation & Door Physics */
    transform-origin: 0% 50%; /* Hinge on Left */
    transition:
      transform 2s cubic-bezier(1, -0.6, 0.2, 1.5),
      opacity 250ms ease;
    will-change: transform, opacity;
  }

  /* subtle floating animation for the accent piece on load */
  @keyframes accentFloat {
    0% {
      transform: translateY(0) scale(1);
      opacity: 0.9;
    }
    50% {
      transform: translateY(-3px) scale(1.02);
      opacity: 1;
    }
    100% {
      transform: translateY(0) scale(1);
      opacity: 0.98;
    }
  }

  /* Only animate float if NOT open */
  .hero-title .accent-text:not(.door-open) {
    animation: accentFloat 2.6s ease-in-out 0.2s both;
  }

  /* The "Open" State - Overrides Float */
  .hero-title .accent-text.door-open {
    transform: rotateY(-130deg) !important; /* Swing open towards screen left */
    animation: none;
  }

  /* hover/interaction — gentle lift (only if not open) */
  .hero-title:hover .primary-text,
  .hero-title:hover .accent-text:not(.door-open) {
    transform: translateY(-2px) scale(1.03);
  }

  /* small decorative underline for accent (keeps it subtle) */
  .hero-title .accent-text::after {
    content: "";
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: -8px;
    width: 60%;
    height: 3px;
    background: linear-gradient(90deg, var(--accent, #ff8c42), #ffb07a);
    border-radius: 2px;
    opacity: 0.75;
    pointer-events: none; /* Let clicks pass through */
  }

  /* Respect users who prefer reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .hero-title .accent-text,
    .hero-title .primary-text {
      transition: none !important;
      animation: none !important;
      transform: none !important;
    }
    .hero-title:hover .primary-text,
    .hero-title:hover .accent-text {
      transform: none !important;
    }
  }

  /* Latest Posts — keep titles prominent but not huge */
  .latest-posts h2 {
    font-size: 1.25rem;
    margin-bottom: 0.75rem;
  }
  .latest-posts a.text-xl.font-bold,
  .latest-posts .title {
    font-size: 1.125rem; /* ~18px */
    line-height: 1.15;
  }
  .latest-posts p {
    font-size: 1rem; /* body-size for descriptions */
    margin-top: 0.4rem;
    color: rgba(64, 64, 64, 0.95);
  }
  .latest-posts .text-sm {
    font-size: 0.875rem;
    color: rgba(100, 100, 100, 0.9);
  }

  /* Make the Interesting Articles list consistent with posts */
  #articles-list .border-b a {
    font-size: 1.05rem;
    font-weight: 600;
  }
  #articles-list .border-b p {
    font-size: 0.95rem;
    color: rgba(100, 100, 100, 0.9);
  }

  /* Reduce spacing so sections feel cohesive */
  .latest-posts .border-b {
    padding-bottom: 0.75rem;
  }
  .latest-posts .mb-12 {
    margin-bottom: 2.25rem;
  }

  /* Responsive adjustments */
  @media (max-width: 720px) {
    .hero-title {
      font-size: clamp(1.9rem, 9vw, 2.6rem);
    }
    .hero-subtitle {
      font-size: 0.98rem;
      padding: 0 0.5rem;
    }
    .latest-posts a.text-xl.font-bold,
    .latest-posts .title {
      font-size: 1.05rem;
    }
    #articles-list .border-b a {
      font-size: 1rem;
    }
  }

  /* Tighter hero */
  .hero-section {
    text-align: center;
    padding: 3rem 0 4rem 0;
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.05), transparent);
    border-radius: 16px;
    margin-bottom: 2rem;
  }

  /* Holiday Mode Substitutions */
  :global(html.holiday-mode) .hero-section {
    background: white;
    box-shadow: none;
    position: relative;
    overflow: hidden; /* Ensure garland doesn't spill out */
  }

  /* New End-to-End Garland */
  :global(html.holiday-mode) .hero-section::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url("/img/holiday/garland.png");
    background-position: center;
    background-repeat: no-repeat;
    background-size: 100% auto; /* Stretch across width */
    z-index: 0;
    opacity: 0.9;
    pointer-events: none;
    mix-blend-mode: multiply;
    filter: contrast(1.5) brightness(1.2);
  }

  /* Ensure content sits above garland */
  :global(html.holiday-mode) .hero-section > * {
    position: relative;
    z-index: 10;
  }
  :global(html.holiday-mode) .default-title {
    display: none;
  }
  :global(html.holiday-mode) .holiday-title {
    display: block;
    max-width: 250px; /* Adjust size to fit header area properly */
    height: auto;
  }
</style>
