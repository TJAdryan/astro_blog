---
import BaseLayout from "../layouts/BaseLayout.astro";
import { ALLOWED_EMAILS } from "../allowed_emails";

const user = await Astro.locals.currentUser();
if (!user) return Astro.redirect("/login");
const userEmail = user?.emailAddresses?.[0]?.emailAddress || "";

// VIP: Redirect Sophio to wedding page immediately
if (userEmail && userEmail.toLowerCase() === "sophiogabatashvili@gmail.com") {
  return Astro.redirect("/wedding");
}

if (ALLOWED_EMAILS.length > 0) {
  if (!userEmail || !ALLOWED_EMAILS.includes(userEmail)) {
    return Astro.redirect("/unauthorized");
  }
}
import Dashboard from "../components/Dashboard.jsx";
import fs from "node:fs";
import path from "node:path";
import { Buffer } from "node:buffer";

// Stats Calculation
let count = 0;
let days = 0;
let avgPerWeek = "0.0";
let hasStarted = false;
let queue = [];

try {
  const logPath = path.resolve("./src/data/completed_log.json");
  if (fs.existsSync(logPath)) {
    const data = fs.readFileSync(logPath, "utf-8");
    const log = JSON.parse(data);
    count = log.length;

    if (count > 0) {
      hasStarted = true;
      // Find the earliest date
      const sortedLog = log.sort(
        (a, b) =>
          new Date(a.completedAt).valueOf() - new Date(b.completedAt).valueOf(),
      );
      const firstDate = new Date(sortedLog[0].completedAt);
      const now = new Date();

      // Calculate days elapsed (min 1 day to avoid divide by zero)
      const diffTime = Math.abs(now.valueOf() - firstDate.valueOf());
      days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      if (days < 1) days = 1;

      // Calculate average
      const rawAvg = (count / days) * 7;
      avgPerWeek = rawAvg.toFixed(1);
    }
  }

  // Load Queue using GitHub API (Real-time)
  const githubToken = import.meta.env.GITHUB_TOKEN || process.env.GITHUB_TOKEN;
  if (githubToken) {
    try {
      const repoOwner = "TJAdryan";
      const repoName = "astro_blog";
      const filePath = "src/data/article_queue.json";
      const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;

      const res = await fetch(url, {
        headers: {
          Authorization: `Bearer ${githubToken}`,
          Accept: "application/vnd.github.v3+json",
          "User-Agent": "Astro-Blog-App",
        },
      });
      if (res.ok) {
        const fileData = await res.json();
        const content = Buffer.from(fileData.content, "base64").toString(
          "utf-8",
        );
        queue = JSON.parse(content);
        console.log("[Dashboard] Fetched queue from GitHub API");
      }
    } catch (e) {
      console.error(
        "[Dashboard] GitHub API fetch failed, falling back to local:",
        e,
      );
    }
  }

  // Fallback to Local File (if GitHub failed or no token)
  if (queue.length === 0) {
    const queuePath = path.resolve("./src/data/article_queue.json");
    if (fs.existsSync(queuePath)) {
      const queueData = fs.readFileSync(queuePath, "utf-8");
      queue = JSON.parse(queueData);
      console.log("[Dashboard] Loaded local queue snapshot");
    }
  }
} catch (e) {
  console.error("Error reading data for dashboard:", e);
}

const stats = { count, days, avgPerWeek };

// User info fetched at top
---

<BaseLayout>
  <Dashboard client:load queue={queue} stats={stats} userEmail={userEmail} />
</BaseLayout>
