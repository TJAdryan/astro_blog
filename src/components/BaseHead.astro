---
// Import the global.css file here so that it is included on
// all pages through the use of the <BaseHead /> component.
import "../styles/global.css";
import type { ImageMetadata } from "astro";
import FallbackImage from "../assets/blog-placeholder-1.jpg";
import { SITE_TITLE } from "../consts";
import PostHogScript from "./PostHogScript.astro";

interface Props {
  title: string;
  description: string;
  image?: ImageMetadata | string;
  favicon?: string;
  noindex?: boolean;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const {
  title,
  description,
  image = FallbackImage,
  favicon = "/favicon.svg",
  noindex = false,
} = Astro.props;
const imageURL = typeof image === "string" ? image : image.src;
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<PostHogScript />
{noindex && <meta name="robots" content="noindex" />}
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href={favicon} />
<link rel="apple-touch-icon" href={favicon} />
<link rel="sitemap" href="/sitemap-index.xml" />
<link
  rel="alternate"
  type="application/rss+xml"
  title={SITE_TITLE}
  href={new URL("rss.xml", Astro.site)}
/>
<meta name="generator" content={Astro.generator} />

<!-- Font preloads -->
<link
  rel="preload"
  href="/fonts/atkinson-regular.woff"
  as="font"
  type="font/woff"
  crossorigin
/>
<link
  rel="preload"
  href="/fonts/atkinson-bold.woff"
  as="font"
  type="font/woff"
  crossorigin
/>

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={new URL(imageURL, Astro.url)} />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={new URL(imageURL, Astro.url)} />

<!-- Mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"
></script>
<script>
  // @ts-nocheck
  declare const mermaid: any;
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize Mermaid
    // @ts-ignore
    mermaid.initialize({
      startOnLoad: false,
      theme: "default",
      securityLevel: "loose",
      flowchart: {
        htmlLabels: true,
        curve: "basis",
      },
      themeVariables: {
        fontSize: "24px",
        fontFamily: "Inter, system-ui, sans-serif",
      },
      logLevel: 5, // Suppress logging
    });

    // Create and inject modal if it doesn't exist
    let modal: HTMLDialogElement | null = document.getElementById(
      "mermaid-modal",
    ) as HTMLDialogElement;
    if (!modal) {
      modal = document.createElement("dialog");
      modal.id = "mermaid-modal";
      modal.className = "mermaid-modal-dialog";
      modal.innerHTML = `
        <form method="dialog" class="close-container">
          <button class="close-btn" aria-label="Close modal">âœ•</button>
        </form>
        <div class="modal-content" id="mermaid-modal-content"></div>
      `;
      document.body.appendChild(modal);

      // Close on backdrop click
      modal.addEventListener("click", (event) => {
        const rect = modal!.getBoundingClientRect();
        const isInDialog =
          rect.top <= event.clientY &&
          event.clientY <= rect.top + rect.height &&
          rect.left <= event.clientX &&
          event.clientX <= rect.left + rect.width;
        if (!isInDialog) {
          modal!.close();
        }
      });
    }

    function openModal(svgContent: string) {
      const modalContent = document.getElementById("mermaid-modal-content");
      if (modalContent && modal) {
        modalContent.innerHTML = svgContent;
        // Ensure SVG in modal is scalable
        const svg = modalContent.querySelector("svg");
        if (svg) {
          // Allow the SVG to be its natural size or larger, up to 100% width of container if it fits
          // But importantly, DO NOT constrain height, so it doesn't shrink text
          svg.style.width = "auto";
          svg.style.height = "auto";
          svg.style.maxWidth = "100%";
          // Remove fixed width/height attributes if they exist to allow CCS scaling
          svg.removeAttribute("width");
          svg.removeAttribute("height");
        }
        modal.showModal();
      }
    }

    // Function to render Mermaid diagrams
    async function renderMermaidDiagrams() {
      // console.log("Rendering mermaid diagrams...");
      const mermaidElements = document.querySelectorAll(".mermaid");
      // console.log(`Found ${mermaidElements.length} mermaid elements`);

      for (let i = 0; i < mermaidElements.length; i++) {
        const element = mermaidElements[i] as HTMLElement;
        if (!element.dataset.processed) {
          // console.log(`Processing mermaid element ${i}`);
          element.dataset.processed = "true";
          const id = `mermaid-${Date.now()}-${i}`;

          try {
            // @ts-ignore
            const { svg } = await mermaid.render(
              id,
              element.textContent?.trim() || "",
            );
            element.innerHTML = svg;

            // Add interaction
            element.style.cursor = "zoom-in";
            element.title = "Click to enlarge";
            element.addEventListener("click", () => openModal(svg));

            // console.log(`Successfully rendered mermaid diagram ${i}`);
          } catch (error: any) {
            console.error("Mermaid rendering error:", error);
            element.innerHTML = `<p style="color: red;">Error rendering diagram: ${error.message}</p>`;
          }
        }
      }
    }

    // Render diagrams
    renderMermaidDiagrams();

    // Also run when navigating in SPA mode
    window.addEventListener("astro:page-load", renderMermaidDiagrams);
  });
</script>

<style is:global>
  /* Mermaid Diagram Styles */
  .mermaid {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    margin: 2rem 0;
    overflow-x: auto;
    border: 1px solid #eee;
    text-align: center;
    transition: box-shadow 0.3s ease;
  }

  .mermaid:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .mermaid svg {
    max-width: 100%;
    height: auto;
  }

  /* Modal Styles */
  .mermaid-modal-dialog {
    border: none;
    border-radius: 12px;
    padding: 0;
    background: transparent;
    box-shadow:
      0 20px 25px -5px rgba(0, 0, 0, 0.1),
      0 10px 10px -5px rgba(0, 0, 0, 0.04);
    max-width: 95vw;
    max-height: 95vh;
    width: auto;
  }

  .mermaid-modal-dialog::backdrop {
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(4px);
  }

  .mermaid-modal-dialog .modal-content {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: center;
    max-height: 90vh; /* Leave room for padding */
    min-width: 300px;
  }

  .mermaid-modal-dialog .close-container {
    position: fixed; /* Fixed relative to dialog viewport or absolute relative to dialog? */
    /* Using absolute relative to dialog is safer */
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 100;
  }

  /* Override button styles from global if needed */
  .mermaid-modal-dialog .close-btn {
    background: var(--accent, #d24e00);
    color: white;
    border: 2px solid white;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    transition:
      background-color 0.2s,
      transform 0.2s;
  }

  .mermaid-modal-dialog .close-btn:hover {
    background-color: var(--accent-dark, #a33b00);
    transform: scale(1.1);
  }
</style>
